<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PPO-AI ‚Äì Pohjoisen Oraakkeli</title>

  <style>
    :root {
      --bg: #050914;
      --panel: rgba(10, 18, 35, 0.55);
      --border: rgba(120, 180, 255, 0.18);
      --text: #e8eefc;
      --muted: rgba(200,220,255,0.65);
      --accent: rgba(88,255,177,0.9);
      --accent2: rgba(75,180,255,0.9);
      --danger: rgba(255,75,75,0.9);
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, sans-serif;
      color: var(--text);
      background: radial-gradient(circle at top, #071a2d, var(--bg));
      overflow-x: hidden;
    }

    /* Background */
    .background {
      position: fixed;
      inset: 0;
      z-index: -5;
      overflow: hidden;
      background: radial-gradient(circle at top, #071a2d, var(--bg));
    }

    .aurora {
      position: absolute;
      inset: -250px;
      background: conic-gradient(
        from 180deg,
        rgba(88, 255, 177, 0.10),
        rgba(75, 180, 255, 0.12),
        rgba(181, 109, 255, 0.10),
        rgba(88, 255, 177, 0.10)
      );
      filter: blur(110px);
      opacity: 0.75;
      animation: auroraMove 12s infinite linear;
    }

    @keyframes auroraMove {
      0% { transform: translateX(-10%) translateY(-10%) rotate(0deg); }
      50% { transform: translateX(10%) translateY(0%) rotate(180deg); }
      100% { transform: translateX(-10%) translateY(-10%) rotate(360deg); }
    }

    .stars {
      position: absolute;
      inset: 0;
      background-image:
        radial-gradient(1px 1px at 20% 30%, rgba(255,255,255,0.7), transparent),
        radial-gradient(1px 1px at 70% 40%, rgba(255,255,255,0.6), transparent),
        radial-gradient(1px 1px at 40% 80%, rgba(255,255,255,0.5), transparent),
        radial-gradient(2px 2px at 85% 65%, rgba(255,255,255,0.55), transparent);
      opacity: 0.85;
    }

    .container {
      max-width: 700px;
      margin: auto;
      padding: 26px 18px;
      text-align: center;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
    }

    /* LOGO */
    .logoWrap {
      margin-top: 70px;
      margin-bottom: 14px;
      display: flex;
      justify-content: center;
      cursor: pointer;
      user-select: none;
      position: relative;
      z-index: 2;
    }

    .logoWrap img {
      width: min(360px, 85vw);
      filter: drop-shadow(0 0 28px rgba(88,255,177,0.40));
      animation: logoGlow 2.6s infinite alternate ease-in-out;
      transition: transform 1.1s ease, width 1.1s ease, opacity 1.1s ease;
    }

    @keyframes logoGlow {
      from { transform: scale(1); opacity: 0.9; }
      to { transform: scale(1.03); opacity: 1; }
    }

    .activateText {
      color: var(--muted);
      font-size: 0.95rem;
      margin-bottom: 25px;
      opacity: 0.9;
      transition: opacity 0.6s ease;
      z-index: 2;
      position: relative;
    }

    /* UI wrapper hidden initially */
    .uiHidden {
      display: none;
      margin-top: 20px;
      width: 100%;
      z-index: 2;
      position: relative;
    }

    /* Panel */
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 22px;
      padding: 18px;
      backdrop-filter: blur(10px);
      box-shadow: 0 0 30px rgba(0,0,0,0.55);
      text-align: left;
    }

    textarea {
      width: 100%;
      margin-top: 6px;
      border-radius: 14px;
      border: 1px solid rgba(120, 180, 255, 0.16);
      background: rgba(5, 10, 25, 0.65);
      color: var(--text);
      padding: 10px 12px;
      font-size: 0.95rem;
      outline: none;
      transition: border 0.2s ease, box-shadow 0.2s ease;
      resize: none;
    }

    textarea:focus {
      border-color: rgba(88,255,177,0.35);
      box-shadow: 0 0 15px rgba(88,255,177,0.12);
    }

    /* Icon buttons */
    .btnRow {
      margin-top: 14px;
      display: flex;
      justify-content: center;
      gap: 12px;
    }

    .iconBtn {
      width: 56px;
      height: 56px;
      border-radius: 18px;
      border: 1px solid rgba(120,180,255,0.22);
      background: rgba(5, 10, 25, 0.55);
      cursor: pointer;
      font-size: 1.4rem;
      display: grid;
      place-items: center;
      transition: transform 0.15s ease, box-shadow 0.2s ease, border 0.2s ease;
      color: rgba(230,240,255,0.9);
      box-shadow: 0 0 15px rgba(0,0,0,0.55);
      position: relative;
    }

    .iconBtn:hover {
      transform: translateY(-2px);
      border-color: rgba(88,255,177,0.35);
      box-shadow: 0 0 20px rgba(88,255,177,0.16);
    }

    .iconBtn:active {
      transform: translateY(1px);
      opacity: 0.9;
    }

    .danger {
      border-color: rgba(255,75,75,0.25);
    }

    .danger:hover {
      border-color: rgba(255,75,75,0.55);
      box-shadow: 0 0 20px rgba(255,75,75,0.15);
    }

    /* Chat */
    .chatPanel {
      margin-top: 16px;
      background: rgba(5, 10, 25, 0.65);
      border: 1px solid rgba(120, 180, 255, 0.14);
      border-radius: 18px;
      padding: 14px;
      min-height: 150px;
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size: 0.9rem;
      box-shadow: inset 0 0 20px rgba(0,0,0,0.6);
      overflow-y: auto;
      max-height: 320px;
    }

    .statusRow {
      margin-top: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      color: var(--muted);
      font-size: 0.9rem;
    }

    .loader {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 3px solid rgba(75,180,255,0.2);
      border-top: 3px solid rgba(88,255,177,0.9);
      animation: spin 0.85s linear infinite;
      display: none;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* Fade-in animation */
    .fade {
      opacity: 0;
      transform: translateY(10px);
      animation: fadeIn 0.8s forwards ease;
    }

    .delay1 { animation-delay: 0.15s; }
    .delay2 { animation-delay: 0.45s; }
    .delay3 { animation-delay: 0.75s; }

    @keyframes fadeIn {
      to { opacity: 1; transform: translateY(0); }
    }

    footer {
      margin-top: 20px;
      color: rgba(200,220,255,0.45);
      font-size: 0.85rem;
      text-align: center;
    }

    /* SETTINGS POPUP */
    .settingsPanel {
      margin-top: 12px;
      background: rgba(5, 10, 25, 0.85);
      border: 1px solid rgba(120, 180, 255, 0.18);
      border-radius: 18px;
      padding: 12px;
      display: none;
    }

    .settingsPanel label {
      display: block;
      font-size: 0.85rem;
      margin-top: 6px;
      color: var(--muted);
      font-weight: 600;
    }

    .settingsPanel select {
      width: 100%;
      margin-top: 6px;
      border-radius: 14px;
      border: 1px solid rgba(120, 180, 255, 0.16);
      background: rgba(5, 10, 25, 0.65);
      color: var(--text);
      padding: 10px 12px;
      font-size: 0.95rem;
      outline: none;
    }

    /* SCREEN TEAR / FLASH EFFECT */
    .flashOverlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle, rgba(88,255,177,0.8), rgba(0,0,0,0));
      opacity: 0;
      pointer-events: none;
      z-index: 50;
      transition: opacity 0.5s ease;
    }

    .tearLine {
      position: fixed;
      left: -20%;
      top: 50%;
      width: 140%;
      height: 4px;
      background: linear-gradient(
        to right,
        transparent,
        rgba(88,255,177,0.9),
        rgba(75,180,255,0.8),
        transparent
      );
      opacity: 0;
      transform: rotate(-4deg);
      z-index: 60;
      pointer-events: none;
      box-shadow: 0 0 25px rgba(88,255,177,0.35);
    }

    .tearAnim {
      animation: tearMove 1.4s ease forwards;
    }

    @keyframes tearMove {
      0% { opacity: 0; transform: translateY(-40px) rotate(-4deg) scaleX(0.1); }
      25% { opacity: 1; transform: translateY(0px) rotate(-4deg) scaleX(1); }
      60% { opacity: 1; transform: translateY(40px) rotate(-4deg) scaleX(1.1); }
      100% { opacity: 0; transform: translateY(120px) rotate(-4deg) scaleX(1.3); }
    }

    .bootText {
      font-family: ui-monospace, monospace;
      font-size: 0.9rem;
      color: rgba(200,220,255,0.75);
      text-align: center;
      margin-top: 12px;
      white-space: pre-line;
      display: none;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 1s ease, transform 1s ease;
    }

    .bootText.show {
      display: block;
      opacity: 1;
      transform: translateY(0px);
    }
  </style>
</head>

<body>
  <div class="background">
    <div class="aurora"></div>
    <div class="stars"></div>
  </div>

  <!-- FX -->
  <div class="flashOverlay" id="flashOverlay"></div>
  <div class="tearLine" id="tearLine"></div>

  <div class="container">

    <!-- LOGO ONLY VIEW -->
    <div class="logoWrap" id="logoWrap">
      <img src="./PPOlogo.png" alt="PPO logo" id="ppoLogo">
    </div>

    <div class="activateText" id="activateText">
      Klikkaa logoa aktivoidaksesi PPO-AI:n.
    </div>

    <div class="bootText" id="bootText"></div>

    <!-- UI hidden until activation -->
    <div class="uiHidden" id="ui">
      <div class="panel fade delay1">

        <textarea id="userInput" rows="2" placeholder="Kirjoita kysymys..."></textarea>

        <div class="btnRow">
          <button class="iconBtn" id="askBtn" title="Kysy">üì®</button>
          <button class="iconBtn" id="talkBtn" title="Puhu">üéôÔ∏è</button>
          <button class="iconBtn" id="settingsBtn" title="Asetukset">‚öôÔ∏è</button>
          <button class="iconBtn danger" id="stopBtn" title="Stop">üõë</button>
          <button class="iconBtn" id="clearBtn" title="Tyhjenn√§">üßπ</button>
        </div>

        <div class="settingsPanel" id="settingsPanel">
          <label>üé≠ Moodi</label>
          <select id="mode">
            <option value="normaali">Normaali PPO</option>
            <option value="kankkarankka">K√§nkk√§r√§nkk√§ PPO</option>
            <option value="sitsikapteeni">Sitsikapteeni PPO</option>
            <option value="filosofi">Pohjoisen filosofi PPO</option>
          </select>
        </div>

        <div class="statusRow">
          <div class="loader" id="loader"></div>
          <div id="status">Valmiina.</div>
        </div>

        <div class="chatPanel fade delay2" id="chatBox"></div>
      </div>

      <footer class="fade delay3">
        ‚ùÑÔ∏è PPO-AI k√§ytt√§√§ Oulun kvanttiprotokollaa
      </footer>
    </div>
  </div>

<script>
  const chatBox = document.getElementById("chatBox");
  const userInput = document.getElementById("userInput");
  const statusEl = document.getElementById("status");
  const modeSelect = document.getElementById("mode");
  const loader = document.getElementById("loader");

  const logoWrap = document.getElementById("logoWrap");
  const activateText = document.getElementById("activateText");
  const ui = document.getElementById("ui");
  const ppoLogo = document.getElementById("ppoLogo");

  const flashOverlay = document.getElementById("flashOverlay");
  const tearLine = document.getElementById("tearLine");
  const bootText = document.getElementById("bootText");

  const settingsBtn = document.getElementById("settingsBtn");
  const settingsPanel = document.getElementById("settingsPanel");

  const osoite = "patamaski-github-io";

  const loadingSound = new Audio("./loading.wav");
  loadingSound.volume = 0.9;

  let activated = false;

  function appendChat(role, text) {
    const prefix = role === "user" ? "üßë " : "ü§ñ ";
    chatBox.textContent += prefix + text + "\n\n";
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function setLoading(isLoading) {
    loader.style.display = isLoading ? "inline-block" : "none";
  }

  function speak(text) {
    if (!("speechSynthesis" in window)) return;
    window.speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = "fi-FI";
    utterance.rate = 1.02;
    utterance.pitch = 1.0;
    window.speechSynthesis.speak(utterance);
  }

  function playLoadingSound() {
    loadingSound.currentTime = 0;
    loadingSound.play().catch(() => {});
  }

  function showFlash() {
    flashOverlay.style.opacity = "1";
    setTimeout(() => {
      flashOverlay.style.opacity = "0";
    }, 550);
  }

  function showTear() {
    tearLine.classList.remove("tearAnim");
    void tearLine.offsetWidth; // restart animation
    tearLine.classList.add("tearAnim");
  }

  function startBootSequence() {
    const lines = [
      "PPO CORE ONLINE...",
      "AURORA LINK ESTABLISHED...",
      "OU LU NODE CONNECTED...",
      "FROST PROTOCOL ACTIVE...",
      "TURKU FIREWALL BYPASSED...",
      "PPO-AI READY."
    ];

    bootText.textContent = "";
    bootText.classList.add("show");

    let i = 0;
    const interval = setInterval(() => {
      bootText.textContent += lines[i] + "\n";
      i++;
      if (i >= lines.length) clearInterval(interval);
    }, 420);
  }

  function activateUI() {
    if (activated) return;
    activated = true;

    playLoadingSound();
    activateText.style.opacity = "0";

    showFlash();
    showTear();
    startBootSequence();

    // logo shrink + move slightly upward
    ppoLogo.style.width = "min(240px, 70vw)";
    ppoLogo.style.opacity = "0.95";
    ppoLogo.style.transform = "translateY(-25px) scale(0.98)";

    // show UI after longer cinematic delay
    setTimeout(() => {
      ui.style.display = "block";
      activateText.style.display = "none";
      userInput.focus();
    }, 2600);
  }

  logoWrap.onclick = activateUI;

  settingsBtn.onclick = () => {
    settingsPanel.style.display = (settingsPanel.style.display === "block") ? "none" : "block";
  };

  async function askBackend(text) {
    const backend = "https://" + osoite + ".onrender.com";

    appendChat("user", text);
    statusEl.textContent = "Analysoidaan...";
    setLoading(true);

    try {
      const res = await fetch(backend + "/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          message: text,
          mode: modeSelect.value
        })
      });

      const data = await res.json();

      if (!res.ok) {
        appendChat("assistant", "Virhe: " + (data.error || "tuntematon"));
        statusEl.textContent = "Virhe.";
        setLoading(false);
        return;
      }

      appendChat("assistant", data.reply);
      speak(data.reply);

      statusEl.textContent = "Valmis.";
      setLoading(false);

    } catch (err) {
      console.error(err);
      appendChat("assistant", "Backend ei vastaa. Oisko Oulu j√§√§ss√§?");
      statusEl.textContent = "Ei yhteytt√§.";
      setLoading(false);
    }
  }

  document.getElementById("askBtn").onclick = () => {
    const text = userInput.value.trim();
    if (!text) return;
    askBackend(text);
  };

  document.get.getElementById?.("clearBtn");
  document.getElementById("clearBtn").onclick = () => {
    chatBox.textContent = "";
    userInput.value = "";
    statusEl.textContent = "Tyhjennetty.";
  };

  // Speech Recognition
  let recognition = null;
  if ("webkitSpeechRecognition" in window) {
    recognition = new webkitSpeechRecognition();
    recognition.lang = "fi-FI";
    recognition.continuous = false;
    recognition.interimResults = false;

    recognition.onstart = () => {
      statusEl.textContent = "Kuuntelen...";
      setLoading(true);
    };

    recognition.onend = () => {
      statusEl.textContent = "Kuuntelu loppui.";
      setLoading(false);
    };

    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript;
      userInput.value = transcript;
      askBackend(transcript);
    };
  } else {
    statusEl.textContent = "Puhe ei toimi t√§ss√§ selaimessa.";
  }

  document.getElementById("talkBtn").onclick = () => {
    if (!recognition) {
      alert("Puheentunnistus ei toimi. Kokeile Chromea.");
      return;
    }
    recognition.start();
  };

  document.getElementById("stopBtn").onclick = () => {
    if (recognition) recognition.stop();
    window.speechSynthesis.cancel();
    statusEl.textContent = "Pys√§ytetty.";
    setLoading(false);
  };
</script>

</body>
</html>