<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PPO-AI â€“ Pohjoisen Oraakkeli</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #0b1220;
      color: #e8eefc;
      max-width: 900px;
      margin: auto;
      padding: 20px;
    }
    h1 { font-size: 2rem; margin-bottom: 0; }
    .subtitle { color: #a9b6d6; margin-top: 5px; }
    .box {
      background: #121c33;
      border-radius: 16px;
      padding: 16px;
      margin-top: 16px;
      box-shadow: 0 0 15px rgba(0,0,0,0.4);
    }
    button {
      border: none;
      border-radius: 12px;
      padding: 12px 16px;
      font-size: 1rem;
      cursor: pointer;
      margin-right: 10px;
      margin-top: 10px;
    }
    .btn-main { background: #2d6cdf; color: white; }
    .btn-stop { background: #d33c3c; color: white; }
    .btn-clear { background: #444; color: white; }
    textarea, input, select {
      width: 100%;
      border-radius: 12px;
      border: 1px solid #2a3555;
      background: #0d152a;
      color: #e8eefc;
      padding: 10px;
      font-size: 1rem;
      margin-top: 6px;
      box-sizing: border-box;
    }
    label { display: block; margin-top: 12px; color: #a9b6d6; }
    .chat {
      white-space: pre-wrap;
      background: #0d152a;
      border: 1px solid #2a3555;
      border-radius: 12px;
      padding: 12px;
      min-height: 120px;
    }
    .small { font-size: 0.9rem; color: #a9b6d6; }
  </style>
</head>
<body>

  <h1>ğŸ§  PPO-AI â€“ Pohjoisen Oraakkeli</h1>
  <div class="subtitle">Kysy mitÃ¤ vain. Saat vastauksen Oulun suunnalta.</div>

  <div class="box">
    <label>ğŸŒ Backend URL (Render-linkki)</label>
    <input id="backendUrl" placeholder="https://your-app.onrender.com" />

    <label>ğŸ­ Valitse moodi</label>
    <select id="mode">
      <option value="normaali">Normaali PPO</option>
      <option value="kankkarankka">KÃ¤nkkÃ¤rÃ¤nkkÃ¤ PPO</option>
      <option value="sitsikapteeni">Sitsikapteeni PPO</option>
      <option value="filosofi">Pohjoisen filosofi PPO</option>
    </select>

    <label>ğŸ¤ Kysy (voit puhua tai kirjoittaa)</label>
    <textarea id="userInput" rows="3"></textarea>

    <button class="btn-main" id="askBtn">ğŸ“¨ Kysy PPO-AI:lta</button>
    <button class="btn-main" id="talkBtn">ğŸ™ï¸ Puhu PPO-AI:lta</button>
    <button class="btn-stop" id="stopBtn">ğŸ›‘ Lopeta puhe</button>
    <button class="btn-clear" id="clearBtn">ğŸ§¹ TyhjennÃ¤</button>

    <div class="small" id="status" style="margin-top: 10px;">Valmiina.</div>
  </div>

  <div class="box">
    <h2>ğŸ’¬ Keskustelu</h2>
    <div class="chat" id="chatBox"></div>
  </div>

<script>
  const chatBox = document.getElementById("chatBox");
  const userInput = document.getElementById("userInput");
  const statusEl = document.getElementById("status");
  const backendUrlInput = document.getElementById("backendUrl");
  const modeSelect = document.getElementById("mode");

  function appendChat(role, text) {
    const prefix = role === "user" ? "ğŸ§‘ SinÃ¤: " : "ğŸ¤– PPO-AI: ";
    chatBox.textContent += prefix + text + "\n\n";
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function speak(text) {
    if (!("speechSynthesis" in window)) return;
    window.speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = "fi-FI";
    window.speechSynthesis.speak(utterance);
  }

  async function askBackend(text) {
    const backend = backendUrlInput.value.trim();
    if (!backend) {
      alert("SyÃ¶tÃ¤ backend URL (Render-linkki).");
      return;
    }

    appendChat("user", text);
    statusEl.textContent = "PPO-AI miettii...";

    try {
      const res = await fetch(backend + "/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          message: text,
          mode: modeSelect.value
        })
      });

      const data = await res.json();

      if (!res.ok) {
        appendChat("assistant", "No joo... nyt tuli virhe: " + (data.error || "tuntematon"));
        statusEl.textContent = "Virhe.";
        return;
      }

      appendChat("assistant", data.reply);
      speak(data.reply);
      statusEl.textContent = "Valmis. Kysy lisÃ¤Ã¤.";

    } catch (err) {
      console.error(err);
      appendChat("assistant", "No joo... backend ei vastaa. Oisko netti poikki?");
      statusEl.textContent = "Backend ei vastaa.";
    }
  }

  document.getElementById("askBtn").onclick = () => {
    const text = userInput.value.trim();
    if (!text) return;
    askBackend(text);
  };

  document.getElementById("clearBtn").onclick = () => {
    chatBox.textContent = "";
    userInput.value = "";
    statusEl.textContent = "Tyhjennetty. Noni.";
  };

  // Speech Recognition
  let recognition = null;
  if ("webkitSpeechRecognition" in window) {
    recognition = new webkitSpeechRecognition();
    recognition.lang = "fi-FI";
    recognition.continuous = false;
    recognition.interimResults = false;

    recognition.onstart = () => statusEl.textContent = "Kuuntelen...";
    recognition.onend = () => statusEl.textContent = "Kuuntelu loppui.";

    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript;
      userInput.value = transcript;
      askBackend(transcript);
    };
  } else {
    statusEl.textContent = "Puheentunnistus ei toimi tÃ¤ssÃ¤ selaimessa. KÃ¤ytÃ¤ Chromea.";
  }

  document.getElementById("talkBtn").onclick = () => {
    if (!recognition) {
      alert("Puheentunnistus ei toimi. Kokeile Chromea.");
      return;
    }
    recognition.start();
  };

  document.getElementById("stopBtn").onclick = () => {
    if (recognition) recognition.stop();
    window.speechSynthesis.cancel();
    statusEl.textContent = "PysÃ¤ytetty.";
  };
</script>

</body>
</html>